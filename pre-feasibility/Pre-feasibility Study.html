
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Cache-Control" content="public, max-age=31536000, immutable">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preliminary Feasibility Study Report Generation</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #0d2235;
            color: white;
        }
        .header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            height: 60px;
        }
        .language-dropdown {
            margin-left: 20px;
        }
        .language-dropdown select {
            padding: 8px;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #333;
            border: 1px solid #ddd;
        }
        .main-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .fullscreen-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('../images/report-gen.png?v=20251030');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 1;
        }
        .content-overlay {
            position: relative;
            z-index: 2;
            padding: 40px 20px;
            background: rgba(13, 34, 53, 0.85);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .welcome-section {
            text-align: center;
            margin-bottom: 40px;
        }
        .welcome-title {
            color: #fff;
            font-size: 2.6rem;
            margin-bottom: 25px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .welcome-message {
            color: #e0e0e0;
            line-height: 1.8;
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.2rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.6);
        }
        .user-info {
            background: rgba(52, 152, 219, 0.2);
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .user-info p {
            margin: 12px 0;
            font-size: 1.1rem;
            color: #f0f0f0;
            display: flex;
        }
        .user-info strong {
            color: #fff;
            min-width: 120px;
            display: inline-block;
            font-weight: 600;
        }
        .report-title {
            text-align: center;
            color: #fff;
            font-size: 2.2rem;
            margin: 40px 0 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .study-type {
            text-align: center;
            font-size: 1.8rem;
            color: #2ecc71;
            margin-bottom: 40px;
            font-weight: 600;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            padding: 15px;
            background: rgba(46, 204, 113, 0.15);
            border-radius: 8px;
        }
        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 40px 0;
        }
        .action-btn {
            padding: 16px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .generate-btn {
            background: linear-gradient(to right, #2ecc71, #27ae60);
            color: white;
        }
        .generate-btn:hover {
            background: linear-gradient(to right, #27ae60, #219653);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }
        .edit-btn {
            background: linear-gradient(to right, #3498db, #2980b9);
            color: white;
        }
        .edit-btn:hover {
            background: linear-gradient(to right, #2980b9, #2573a7);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }
        .terms-section {
            margin: 40px 0 20px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }
        .checkbox-group input {
            transform: scale(1.5);
        }
        .terms-text {
            color: #e0e0e0;
            line-height: 1.6;
            font-size: 1.1rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .comparison-section {
            margin: 30px 0;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }
        .comparison-section h4 {
            margin: 0 0 15px 0;
            color: #fff;
            font-weight: 600;
        }
        .comparison-options {
            display: flex;
            flex-wrap: wrap;
            gap: 12px 20px;
            align-items: center;
        }
        .comparison-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 8px 12px;
            border-radius: 8px;
            color: #e0e0e0;
            cursor: pointer;
            -ms-user-select: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .comparison-options input[type="checkbox"] {
            transform: scale(1.2);
        }
        @media (max-width: 768px) {
            .buttons-container {
                flex-direction: column;
                align-items: center;
            }
            .action-btn {
                width: 100%;
                max-width: 300px;
            }
            .container {
                padding: 20px;
            }
            .welcome-title {
                font-size: 2.2rem;
            }
            .welcome-message {
                font-size: 1rem;
            }
            .user-info p {
                flex-direction: column;
            }
            .user-info strong {
                min-width: auto;
                margin-bottom: 5px;
            }
            .checkbox-group {
                flex-direction: column;
                text-align: center;
            }
        }
        /* Accessibility helpers */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 1px, 1px);
            white-space: nowrap;
            border: 0;
        }
        /* Inline style cleanup to classes */
        .debug-link {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 8px;
            background: linear-gradient(to right, #8e44ad, #6c3483);
            color: #fff;
            font-weight: 700;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        .report-view {
            background: #fff;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            margin-top: 10px;
            min-height: 120px;
        }
        .buttons-container.spaced { margin-top: 20px; }
        /* Inline cleanup: moved from element attributes */
        .header-right { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); }
        #data-status.status-space { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="language-dropdown">
            <label for="language-selector" class="sr-only">Select language</label>
            <select id="language-selector" title="Select language">
                <option value="en">English</option>
                <option value="ar">العربية</option>
                <option value="fr">Français</option>
                <option value="es">Español</option>
                <option value="zh">中文</option>
            </select>
        </div>
        <img src="../images/LOGO PH.png?v=20251030" alt="Company Logo" class="logo">
        <div class="header-right">
            <a href="../debug-prompt.html" target="_blank" rel="noopener" class="debug-link">AI Data Debug</a>
        </div>
    </div>

    <div class="main-content">
        <div class="fullscreen-bg"></div>
        
        <div class="content-overlay">
        <div class="container">
                <div class="welcome-section">
                    <h1 class="welcome-title">Thank you for completing the data entry!</h1>
                    <div class="welcome-message">
                        <p>Your report is now ready for generation! The report will contain a clear and comprehensive summary of all your study results, giving you an initial insight into your project's feasibility and how it compares to alternative investment options.</p>
                    </div>
                    
                    <div class="user-info">
                        <!-- User data will be dynamically populated from dashboard.html -->
                        <p><strong>Name:</strong> <span id="user-name">John Doe</span></p>
                        <p><strong>Country:</strong> <span id="country-name">ABC Enterprises</span></p>
                        <p><strong>Project:</strong> <span id="project-name">E-commerce Platform</span></p>
                        <p><strong>Email:</strong> <span id="user-email">john.doe@example.com</span></p>
                    </div>
                    <div class="comparison-section">
                        <h4>Do you want to compare the project with other investments? (Optional)</h4>
                        <div class="comparison-options">
                            <label><input type="checkbox" id="compare-cryptocurrencies"> Cryptocurrencies</label>
                            <label><input type="checkbox" id="compare-stocks"> Company stocks</label>
                            <label><input type="checkbox" id="compare-metals"> Metals</label>
                            <label><input type="checkbox" id="compare-bonds"> Bank bonds</label>
                            <label><input type="checkbox" id="compare-deposits"> Deposits</label>
                            <label><input type="checkbox" id="compare-real-estate"> Real estate</label>
                            <label><input type="checkbox" id="compare-mutual-funds"> Mutual funds / ETFs</label>
                            <label><input type="checkbox" id="compare-none"> No, thanks</label>
                        </div>
                    </div>
                </div>
                
                <h2 class="report-title">Generate Feasibility Study Report</h2>
                
                <div class="study-type">
                    <!-- Study type will be dynamically populated from start-feasibility.html -->
                    <span id="study-type">Preliminary Feasibility Study</span>
                </div>
                
                <div class="buttons-container">
                    <button class="action-btn generate-btn" id="generate-report">Generate Report Now</button>
                    <button class="action-btn edit-btn" id="back-button">Back to Edit Data</button>
                </div>

                <!-- Status + Structured report preview area -->
                <div id="data-status" class="status-space"></div>
                <div id="report-view" class="report-view">
                </div>

                <div class="buttons-container spaced">
                    <button class="action-btn generate-btn" id="download-pdf" disabled>Download PDF</button>
                </div>
                
                <div class="terms-section">
                    <div class="checkbox-group">
                        <input type="checkbox" id="agree-terms">
                        <label for="agree-terms" class="terms-text">
                            I agree to the policies and terms, and consent to the use of my data for development, educational, and scientific research purposes.
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Integration fix (pre-feasibility/Pre-feasibility Study.html only):
         Define script error handler BEFORE external scripts so onerror hooks can report issues. -->
    <script>
        // Integration fix (pre-feasibility/Pre-feasibility Study.html only): Central script load error reporter
        window.__scriptLoadError = function(label, src) {
            try {
                const el = document.getElementById('data-status');
                const where = src ? ` (${src})` : '';
                if (el) {
                    const msg = `Failed to load script: ${label}${where}. Some features may not work.`;
                    const box = document.createElement('div');
                    box.className = 'error-message';
                    box.style.cssText = 'background:#ffefef;color:#b00020;padding:10px;border-radius:6px;margin:8px 0;border:1px solid #ffd0d0;';
                    box.textContent = msg;
                    el.appendChild(box);
                }
                console.error('[ScriptLoadError]', label, src || '');
            } catch (_) {}
        };
    </script>

    <!-- pdfmake: required for PDF generation (deferred + onerror) -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.11/pdfmake.min.js?v=20251030"
            onerror="window.__scriptLoadError('pdfmake', this && this.src)"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.11/vfs_fonts.js?v=20251030"
            onerror="window.__scriptLoadError('pdfmake vfs_fonts', this && this.src)"></script>

    <!-- App config: API key and expert prompt (deferred + onerror) -->
    <script src="../config.js?v=20251030" defer onerror="window.__scriptLoadError('config.js', this && this.src)"></script>

    <!-- Integration fix (pre-feasibility/Pre-feasibility Study.html only):
         Remove broken import of ../src/stores/simulatedAnswersStore.js (file not present in repo).
         All data is persisted and read via FeasibilityDB (Dexie/IndexedDB). -->
    <script>
        // No-op placeholder to document removal of missing module (integration task scope only)
        window.__simulatedAnswersStoreRemoved = true;
    </script>

    <!-- Dexie.js + FeasibilityDB (IndexedDB wrapper)
         STORAGE MIGRATION: All data is saved to IndexedDB using Dexie via feasibility-db.js.
         Do not use localStorage/sessionStorage. -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js?v=20251030"></script>
    <script src="../feasibility-db.js?v=20251030"></script>
    <script>
      // Ensure FeasibilityDB is initialized before AI modules
      (function(){
        try {
          if (window.FeasibilityDB && typeof window.FeasibilityDB.whenReady === 'function') {
            window.FeasibilityDB.whenReady().catch(function(){ /* UI handled by feasibility-db */ });
          }
        } catch(_) {}
      })();
    </script>
    <!-- Survey logic disabled on this page: decoupled from surveyLogic.js by design. -->
    <!-- <script src="surveyLogic.js" defer onerror="window.__scriptLoadError('surveyLogic.js', this && this.src)"></script> -->

    <!-- Decoupled legacy module: ai-survey-report.js intentionally disconnected to avoid interference -->
    <!-- Replaced with unified generator: ai-report.js -->
    <script src="../ai-report.js?v=20251030" defer onerror="window.__scriptLoadError('ai-report.js', this && this.src)"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Language selector functionality + persistence
            const langSel = document.getElementById('language-selector');
            try {
                (async function(){
                  const savedLang = await (window.FeasibilityDB ? window.FeasibilityDB.getString('preferredLanguage', null) : null);
                  if (savedLang) {
                    if (langSel) langSel.value = savedLang;
                    document.body.dir = (savedLang === 'ar') ? 'rtl' : 'ltr';
                  }
                })();
            } catch (_) {}
            langSel.addEventListener('change', function() {
                const val = this.value;
                (async function(){ try { await window.FeasibilityDB.setString('preferredLanguage', val); } catch(_) {} })();
                document.body.dir = (val === 'ar') ? 'rtl' : 'ltr';
            });
            
            // ai-report.js binds the Generate and Download buttons on DOMContentLoaded
            // If it fails to load, the onerror handler above will surface a message.
            
            // Back button functionality - returns to previous page
            document.getElementById('back-button').addEventListener('click', function() {
                window.history.back();
            });
            
            // Canonical identity reader and UI updater (no legacy fallbacks)
            async function readCanonicalIdentity() {
                const read = async (key) => {
                    try { return (await window.FeasibilityDB.getString(key, '')).trim(); } catch(_) { return ''; }
                };
                return {
                    userName: await read('userName'),
                    userEmail: await read('userEmail'),
                    userCountry: await read('userCountry'),
                    userCity: await read('userCity'),
                    projectName: await read('projectName'),
                    studyType: await read('studyType')
                };
            }

            async function updateIdentityUI() {
                const vals = await readCanonicalIdentity();
                const safe = (s) => String(s || '');
                const countryCity = vals.userCountry && vals.userCity ? `${vals.userCountry}, ${vals.userCity}` : (vals.userCountry || vals.userCity || '');
                const elUser = document.getElementById('user-name'); if (elUser) elUser.textContent = safe(vals.userName);
                const elEmail = document.getElementById('user-email'); if (elEmail) elEmail.textContent = safe(vals.userEmail);
                const elCountry = document.getElementById('country-name') || document.getElementById('company-name'); if (elCountry) elCountry.textContent = safe(countryCity);
                const elProj = document.getElementById('project-name'); if (elProj) elProj.textContent = safe(vals.projectName);
                const elStudy = document.getElementById('study-type'); if (elStudy && vals.studyType) elStudy.textContent = safe(vals.studyType);
            }

            // Initial render
            (async function(){ try { await updateIdentityUI(); } catch(_) {} })();

            // Keep displayed identity in sync with unified storage keys
            window.addEventListener('storage', function(e){
                if (!e || !e.key) return;
                if ([
                    'userInfo','userName','userEmail','userCountry','userCity','projectName'
                ].includes(e.key)) {
                    (async function(){ try { await updateIdentityUI(); } catch(_) {} })();
                }
            });

            // Expose canonical identity helpers to other scripts in this page
            try { window.__readCanonicalIdentity = readCanonicalIdentity; } catch(_) {}
            try { window.__updateIdentityUI = updateIdentityUI; } catch(_) {}

            // Ensure preferredLanguage exists for AI prompt
            const headerLang = document.getElementById('language-selector')?.value || 'en';
            (async function(){
              try {
                const v = await (window.FeasibilityDB ? window.FeasibilityDB.getString('preferredLanguage', null) : null);
                if (!v) await window.FeasibilityDB.setString('preferredLanguage', headerLang);
              } catch(_) {}
            })();
            
            // Local, self-contained utilities (decoupled from surveyLogic.js)
            function __localSanitizeData(value) {
                try {
                    if (value == null) return value;
                    if (typeof value === 'string') {
                        const trimmed = value.trim();
                        return trimmed.replace(/<\/?script[^>]*>/gi, '').replace(/javascript:\s*/gi, '');
                    }
                    if (Array.isArray(value)) return value.map(__localSanitizeData);
                    if (typeof value === 'object') {
                        const out = {};
                        Object.keys(value).forEach((k) => {
                            const v = value[k];
                            if (v === undefined) return;
                            if (typeof v === 'function') return;
                            out[k] = __localSanitizeData(v);
                        });
                        return out;
                    }
                    return value;
                } catch (_) { return value; }
            }

            function __localDeepFilter(obj) {
                try {
                    if (obj == null) return obj;
                    if (typeof obj === 'string') return obj.trim();
                    if (Array.isArray(obj)) {
                        const arr = obj.map(__localDeepFilter).filter((v) => !(v === '' || v == null));
                        return arr;
                    }
                    if (typeof obj === 'object') {
                        const out = {};
                        Object.keys(obj).forEach((k) => {
                            const v = __localDeepFilter(obj[k]);
                            const isEmptyObj = v && typeof v === 'object' && !Array.isArray(v) && Object.keys(v).length === 0;
                            const isEmptyArr = Array.isArray(v) && v.length === 0;
                            const isEmptyStr = v === '';
                            if (!(v == null || isEmptyObj || isEmptyArr || isEmptyStr)) out[k] = v;
                        });
                        return out;
                    }
                    return obj;
                } catch (_) { return obj; }
            }


            // Comparison checkboxes logic
            const noThanksCheckbox = document.getElementById('compare-none');
            const comparisonCheckboxes = [
                document.getElementById('compare-cryptocurrencies'),
                document.getElementById('compare-stocks'),
                document.getElementById('compare-metals'),
                document.getElementById('compare-bonds'),
                document.getElementById('compare-deposits'),
                document.getElementById('compare-real-estate'),
                document.getElementById('compare-mutual-funds')
            ];

            if (noThanksCheckbox) {
                noThanksCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        comparisonCheckboxes.forEach(function(cb) {
                            if (cb) {
                                cb.checked = false;
                                cb.disabled = true;
                            }
                        });
                    } else {
                        comparisonCheckboxes.forEach(function(cb) {
                            if (cb) cb.disabled = false;
                        });
                    }
                });
            }

            // Persist comparison selection for AI report generator (debounced to avoid excessive writes)
            let __compareSaveTimer = null;
            function saveComparisonSelection() {
                try {
                    const selected = comparisonCheckboxes
                        .filter(Boolean)
                        .filter((el) => el.checked)
                        .map((el) => (el.id || '').replace('compare-',''));
                    // Sanitize and deep-filter comparison data before persisting/using (local, self-contained).
                    const cleaned = (function(v){
                        try {
                            const s = __localSanitizeData(v);
                            return __localDeepFilter(s);
                        } catch (_) { return v; }
                    })(selected);
                    if (__compareSaveTimer) clearTimeout(__compareSaveTimer);
                    __compareSaveTimer = setTimeout(function(){
                      (async function(){ try { await window.FeasibilityDB.setJSON('comparisonAnswers', cleaned); } catch(_) {} })();
                    }, 600);
                    window.__lastComparisonSelection = Array.isArray(cleaned) ? cleaned.slice() : [];
                    // UI refresh can be expensive; trigger only on major actions
                } catch (_) {}
            }

            comparisonCheckboxes.forEach(function(cb) {
                if (!cb) return;
                cb.addEventListener('change', function() {
                    if (this.checked && noThanksCheckbox) {
                        noThanksCheckbox.checked = false;
                        comparisonCheckboxes.forEach(function(other) {
                            if (other) other.disabled = false;
                        });
                    }
                    saveComparisonSelection();
                });
            });
            if (noThanksCheckbox) {
                noThanksCheckbox.addEventListener('change', saveComparisonSelection);
            }
        });
    </script>
    
    <!-- Integration additions (pre-feasibility/Pre-feasibility Study.html only):
         Central data aggregator, UI sync, and storage listeners -->
    <script>
        // Central aggregator to unify data from feasibilityStudyAnswers, simulatedFeasibilityAnswers, and financialStatements
        // (pre-feasibility/Pre-feasibility Study.html only)
        (function(){
            async function readJSON(key, fallback) {
                try { return await (window.FeasibilityDB ? window.FeasibilityDB.getJSON(key, fallback) : fallback); } catch (_) { return fallback; }
            }

            async function readUnifiedSchema() {
                try { return await (window.FeasibilityDB ? window.FeasibilityDB.getJSON('feasibilityUnifiedSchema', null) : null) || undefined; } catch (_) {}
                // Fallback mirrors ai-report.js and surveyLogic.js aliases
                return { aliasToCanonical: {
                    technologyMaturity: 'technologyModernity',
                    politicalStabilityExplanation: 'stabilityExplanation',
                    regulatoryExplanation: 'exposureExplanation',
                    behaviorExplanation: 'alignmentExplanation',
                    environmentExplained: 'environmentalImpact',
                    gdpContribution: 'gdpImpact',
                    operations: 'operationalEfficiency',
                    hasAdditionalInvestments: 'needsAdditionalInvestments'
                }};
            }

            async function canonicalizeKeys(obj) {
                const schema = await readUnifiedSchema();
                const alias = (schema && schema.aliasToCanonical) || {};
                const src = obj || {};
                const out = {};
                Object.keys(src).forEach((k) => {
                    const mapped = k; // Identity mapping; aliases handled by schema fallback
                    const canonical = alias[mapped] || mapped;
                    out[canonical] = src[k];
                });
                // Unify targetAge from min/max if needed
                if (!out.targetAge && (out.targetAgeMin || out.targetAgeMax)) {
                    const min = (out.targetAgeMin != null) ? String(out.targetAgeMin).trim() : '';
                    const max = (out.targetAgeMax != null) ? String(out.targetAgeMax).trim() : '';
                    if (min || max) out.targetAge = [min || '—', max || '—'].join(' - ');
                    delete out.targetAgeMin; delete out.targetAgeMax;
                }
                return out;
            }

            function isEmptyValue(v){
                if (v == null) return true;
                if (typeof v === 'string') return v.trim() === '';
                if (Array.isArray(v)) return v.length === 0;
                if (typeof v === 'object') return Object.keys(v).length === 0;
                return false;
            }

            function deepMergePreferNonEmpty(a,b){
                const isObj = (x) => x && typeof x === 'object' && !Array.isArray(x);
                if (isObj(a) && isObj(b)) {
                    const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
                    const out = {}; keys.forEach(k => out[k] = deepMergePreferNonEmpty(a[k], b[k])); return out;
                }
                if (Array.isArray(a) && Array.isArray(b)) return isEmptyValue(b) ? a : b;
                if (b === undefined || b === null) return a;
                if (typeof b === 'string') return (b.trim() === '') ? a : b;
                return b;
            }

            // Local, self-contained utilities (decoupled from surveyLogic.js)
            function localSanitizeData(value) {
                try {
                    if (value == null) return value;
                    if (typeof value === 'string') {
                        const trimmed = value.trim();
                        return trimmed.replace(/<\/?script[^>]*>/gi, '').replace(/javascript:\s*/gi, '');
                    }
                    if (Array.isArray(value)) return value.map(localSanitizeData);
                    if (typeof value === 'object') {
                        const out = {};
                        Object.keys(value).forEach((k) => {
                            const v = value[k];
                            if (v === undefined) return;
                            if (typeof v === 'function') return;
                            out[k] = localSanitizeData(v);
                        });
                        return out;
                    }
                    return value;
                } catch (_) { return value; }
            }

            function localDeepFilter(obj) {
                try {
                    if (obj == null) return obj;
                    if (typeof obj === 'string') return obj.trim();
                    if (Array.isArray(obj)) {
                        const arr = obj.map(localDeepFilter).filter((v) => !(v === '' || v == null));
                        return arr;
                    }
                    if (typeof obj === 'object') {
                        const out = {};
                        Object.keys(obj).forEach((k) => {
                            const v = localDeepFilter(obj[k]);
                            const isEmptyObj = v && typeof v === 'object' && !Array.isArray(v) && Object.keys(v).length === 0;
                            const isEmptyArr = Array.isArray(v) && v.length === 0;
                            const isEmptyStr = v === '';
                            if (!(v == null || isEmptyObj || isEmptyArr || isEmptyStr)) out[k] = v;
                        });
                        return out;
                    }
                    return obj;
                } catch (_) { return obj; }
            }

            function ensureFinancial(data){
                const fs = (data && data.financialStatements && typeof data.financialStatements === 'object') ? data.financialStatements : {};
                data.financialStatements = {
                    assumptions: Array.isArray(fs.assumptions) ? fs.assumptions : [],
                    incomeStatement: (fs.incomeStatement && Array.isArray(fs.incomeStatement.headers)) ? fs.incomeStatement : { headers: [], rows: [] },
                    balanceSheet: (fs.balanceSheet && Array.isArray(fs.balanceSheet.headers)) ? fs.balanceSheet : { headers: [], rows: [] },
                    cashFlow: (fs.cashFlow && Array.isArray(fs.cashFlow.headers)) ? fs.cashFlow : { headers: [], rows: [] },
                    ratios: Array.isArray(fs.ratios) ? fs.ratios : [],
                    roi: (fs.roi && typeof fs.roi === 'object') ? fs.roi : {}
                };
                return data;
            }

            function sanitize(obj){ return localSanitizeData(obj); }
            function filterDeep(obj){ return localDeepFilter(obj); }

            // Public aggregator
            window.getUnifiedData = async function getUnifiedData(){
                const primary = await canonicalizeKeys(await readJSON('feasibilityStudyAnswers', {}));
                const simulated = await canonicalizeKeys(await readJSON('simulatedFeasibilityAnswers', {}));
                const merged = {};
                const keys = new Set([...Object.keys(primary), ...Object.keys(simulated)]);
                keys.forEach((k) => { merged[k] = deepMergePreferNonEmpty(primary[k], simulated[k]); });
                if (simulated && simulated.financialStatements) {
                    merged.financialStatements = deepMergePreferNonEmpty(merged.financialStatements, simulated.financialStatements);
                }
                // Integration addition (pre-feasibility only): supplement with startFeasibilityForm for basic info
                try {
                    const startForm = await readJSON('startFeasibilityForm', {});
                    ['studyType','projectName','projectDescription','visionMission','sector','projectType','specifiedProjectType','country','city','area','currency','totalCapital','targetAudience','projectStatus','duration','durationUnit']
                      .forEach((k) => { if (startForm[k] != null && merged[k] == null) merged[k] = startForm[k]; });
                } catch (_) {}
                // Integration addition (pre-feasibility only): enrich with user info (author)
                try {
                    const ui = await readJSON('userInfo', {});
                    // Canonical identity only (no legacy root fallbacks)
                    if (merged.fullName == null) merged.fullName = ui.userName || ui.fullName || ui.name || '';
                    if (merged.userEmail == null) merged.userEmail = ui.userEmail || '';
                    if (merged.country == null) merged.country = ui.userCountry || '';
                    if (merged.city == null) merged.city = ui.userCity || '';
                } catch (_) {}
                // Normalize dynamic arrays
                ['staffTable','technologyTable','licensesTable','risksTable','investmentsTable'].forEach((k) => {
                    if (!Array.isArray(merged[k])) merged[k] = Array.isArray(primary[k]) ? primary[k] : (Array.isArray(simulated[k]) ? simulated[k] : []);
                });
                if (merged.equipmentList == null) merged.equipmentList = (typeof primary.equipmentList === 'string' && primary.equipmentList) ? primary.equipmentList : (typeof simulated.equipmentList === 'string' ? simulated.equipmentList : '');
                ensureFinancial(merged);
                return filterDeep(sanitize(merged));
            };

            // UI sync helpers
            function essentialIssues(d){
                const issues = [];
                if (!d || typeof d !== 'object') { issues.push('Data object missing'); return issues; }
                if (!d.projectIdea && !d.projectDescription) issues.push('Project description missing');
                if (!d.financialStatements || !Array.isArray(d.financialStatements?.incomeStatement?.headers)) issues.push('Financial statements incomplete');
                return issues;
            }

            window.__refreshPreFeasibilityUI = async function(){
                try {
                    const status = document.getElementById('data-status');
                    const dbg = document.getElementById('debug-content');
                    const data = await window.getUnifiedData();
                    const problems = essentialIssues(data);
                    if (status) {
                        const ok = problems.length === 0;
                        status.innerHTML = ok
                          ? '<div style="background:#e7f8ee;color:#1b5e20;padding:10px;border-radius:6px;border:1px solid #b8e6c6;">All required data loaded successfully.</div>'
                          : '<div style="background:#fff7e6;color:#8a5300;padding:10px;border-radius:6px;border:1px solid #ffe0a3;">Warning: ' + problems.join('; ') + '.</div>';
                    }
                    // Integration addition (pre-feasibility only): keep header UI in sync with unified data
                    try {
                        const pn = document.getElementById('project-name');
                        const st = document.getElementById('study-type');
                        const un = document.getElementById('user-name');
                        const ue = document.getElementById('user-email');
                        const cn = document.getElementById('country-name') || document.getElementById('company-name');
                        if (pn && data.projectName) pn.textContent = String(data.projectName);
                        if (st && data.studyType) st.textContent = String(data.studyType);
                        if (un && data.fullName) un.textContent = String(data.fullName);
                        if (ue && data.userEmail) ue.textContent = String(data.userEmail);
                        if (cn && (data.country || data.city)) cn.textContent = data.city ? `${data.country || ''}, ${data.city}` : String(data.country || '');
                    } catch (_) {}
                    if (dbg) {
                        const snippet = {
                            projectName: data.projectName,
                            studyType: data.studyType,
                            totalEmployees: data.totalEmployees,
                            financialHasTables: !!(data.financialStatements && data.financialStatements.incomeStatement && Array.isArray(data.financialStatements.incomeStatement.headers))
                        };
                        dbg.textContent = JSON.stringify(snippet, null, 2);
                    }
                } catch (_) {}
            };

            // Auto-refresh when storage changes
            window.addEventListener('storage', function(e){
                if (!e || !e.key) return;
                // Refresh when core data sources change (dashboard + start-feasibility + feasibility data)
                if ([
                    'feasibilityStudyAnswers',
                    'simulatedFeasibilityAnswers',
                    'comparisonAnswers',
                    // Dashboard-updated keys (canonical only)
                    'userInfo', 'userName', 'userEmail', 'userCountry', 'userCity',
                    // Start-feasibility-updated keys (canonical only)
                    'projectName', 'startFeasibilityForm'
                ].includes(e.key)) {
                    window.__refreshPreFeasibilityUI();
                }
            });

            // Initial pass after page load
            document.addEventListener('DOMContentLoaded', function(){
                window.__refreshPreFeasibilityUI();
            });
        })();
    </script>
    <style>
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
        }
        .debug-toggle {
            color: #3498db;
            cursor: pointer;
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
        }
    </style>
    <div class="debug-toggle" id="debug-toggle">Show Debug Information</div>
    <div class="debug-info" id="debug-info">
        <h4>Debug Information (Data Sources)</h4>
        <div id="debug-content"></div>
    </div>
</body>
</html>
